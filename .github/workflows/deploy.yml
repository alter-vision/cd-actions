name: Deploy

on:
  workflow_call:
    inputs:
      project:
        description: 'Project name'
        required: true
        type: string

jobs:
  Helmfile:
    name: Helmfile
    runs-on: worklab
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Deploy service
        env:
          GITHUB_PROJECT_NAME: ${{ inputs.project }}
          DOCKERHUB_REGISTRY: altervisionhub
        run: |
          set -x
          export PATH=/usr/local/link:$PATH
          helmfile -f deploy/helmfile.yaml --log-level info apply --suppress-secrets
